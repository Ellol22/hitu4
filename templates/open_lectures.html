{% extends 'base.html' %}
{% load static %}

{% block content %}
<div class="container mt-5">
    <h2>ğŸ“š Ø§Ù„Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ø§Ù„Ù…ØªØ§Ø­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹</h2>
    <div id="lectures-container" class="mt-4"></div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function () {
    fetch('/attendance/student/open-lectures/')  // Ø§ØªØ£ÙƒØ¯ Ø£Ù† Ø¯Ø§ URL Ø¨ØªØ§Ø¹Ùƒ
        .then(response => response.json())
        .then(data => {
            const container = document.getElementById('lectures-container');

            if (data.status !== 'success' || data.open_lectures.length === 0) {
                container.innerHTML = '<p class="text-muted">Ù„Ø§ ØªÙˆØ¬Ø¯ Ù…Ø­Ø§Ø¶Ø±Ø§Øª Ù…ÙØªÙˆØ­Ø© Ø­Ø§Ù„ÙŠØ§Ù‹.</p>';
                return;
            }

            data.open_lectures.forEach(lecture => {
                const card = document.createElement('div');
                card.className = 'card mb-4 shadow-sm';
                card.innerHTML = `
                    <div class="card-body">
                        <h5 class="card-title">ğŸ“˜ ${lecture.course_name}</h5>
                        <p class="card-text">ğŸ“… Ø§Ù„ØªØ§Ø±ÙŠØ®: ${lecture.lecture_date}</p>
                        <img src="${lecture.qr_image_url}" alt="QR Code" class="img-thumbnail mb-3" style="max-width: 200px;">
                        <button class="btn btn-primary" onclick="verifyLocation(${lecture.lecture_id})">âœ… Ø­Ø¶Ù‘Ø±Ù†ÙŠ</button>
                    </div>
                `;
                container.appendChild(card);
            });
        });
});

function verifyLocation(lectureId) {
    if (!navigator.geolocation) {
        alert("ğŸŒ Ø¬Ù‡Ø§Ø²Ùƒ Ù„Ø§ ÙŠØ¯Ø¹Ù… ØªØ­Ø¯ÙŠØ¯ Ø§Ù„Ù…ÙˆÙ‚Ø¹.");
        return;
    }

    navigator.geolocation.getCurrentPosition(function (position) {
        const requestData = {
            latitude: position.coords.latitude,
            longitude: position.coords.longitude,
            course_id: lectureId,
            student_structure_id: 123  // ğŸ‘ˆ ØºÙŠØ± Ø¯ÙŠ Ø¨Ø¹Ø¯ÙŠÙ† Ù„Ùˆ Ø¹Ø§ÙŠØ² ØªØ®Ù„ÙŠÙ‡Ø§ Ø¯ÙŠÙ†Ø§Ù…ÙŠÙƒÙŠØ©
        };

        fetch('/api/verify-location/', {
            method: 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(requestData)
        })
        .then(res => res.json())
        .then(response => {
            if (response.inside) {
                alert(`âœ… ØªÙ… Ø§Ù„ØªØ­Ù‚Ù‚: Ø§Ù†Øª Ø¯Ø§Ø®Ù„ Ù…Ø¨Ù†Ù‰ ${response.building}.`);
                // ØªÙ‚Ø¯Ø± ØªØ¶ÙŠÙ Ù‡Ù†Ø§ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø­Ø¶ÙˆØ± Ù„Ùˆ Ø¹Ø§ÙŠØ²
            } else {
                alert("âŒ Ø§Ù†Øª Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…Ø¨Ù†Ù‰ Ø§Ù„Ù…Ø­Ø¯Ø¯. Ø­Ø§ÙˆÙ„ ØªÙ‚Ø±Ù‘Ø¨ Ø£ÙƒØªØ±.");
            }
        })
        .catch(error => {
            console.error('Error verifying location:', error);
            alert('âš ï¸ Ø­ØµÙ„ Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø§Ù„Ù…ÙˆÙ‚Ø¹.');
        });
    });
}
</script>
{% endblock %}
